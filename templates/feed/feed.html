{% include "includes/header.html" %}

<div class="container-md feed">

  {% if posts %}
    {% for post in posts %}
      <div class="blogpost">

        <!-- USERNAME -->
        <div class="blogpost-title">
          <p>@{{ post.username }}</p>
        </div>

        <!-- MEDIA -->
        <div class="blogpost-post">
          {% if post.media_type == "image" %}
            <img
              src="{{ url_for('static', filename=post.media_path) }}"
              alt="Post image"
              loading="lazy"
            >
          {% elif post.media_type == "video" %}
            <video controls preload="metadata">
              <source
                src="{{ url_for('static', filename=post.media_path) }}"
                type="video/mp4"
              >
              Your browser does not support the video tag.
            </video>
          {% endif %}
        </div>

        <!-- CAPTION -->
        <div class="blogpost-content">
          <p>
            <strong>{{ post.username }}</strong>
            {% if post.caption %}
              â€“ {{ post.caption }}
            {% endif %}
          </p>
        </div>

        <!-- LIKES -->
        <div class="blogpost-actions" data-post-id="{{ post.id }}">
          <button
            type="button"
            class="like-button {% if post.liked_by_current_user %}liked{% endif %}"
            data-post-id="{{ post.id }}"
            aria-pressed="{{ 1 if post.liked_by_current_user else 0 }}"
          >
            <span class="like-icon">&hearts;</span>
            <span class="like-label">
              {% if post.liked_by_current_user %}
                Je vindt dit leuk
              {% else %}
                Vind ik leuk
              {% endif %}
            </span>
          </button>
          <span class="like-count">{{ post.like_count or 0 }}</span>
          {% if session.user_name == "admin" %}
            <form method="POST"
                  action="{{ url_for('delete_post', post_id=post.id) }}"
                  onsubmit="return confirm('Weet je zeker dat je deze post wilt verwijderen?');"
                  style="display: inline;">
              <button type="submit" class="btn btn-danger btn-sm">Delete</button>
            </form>
          {% endif %}
        </div>

      </div>
    {% endfor %}
  {% else %}
    <p class="text-center text-muted mt-4">
      Nog geen posts.
    </p>
  {% endif %}

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const likeButtons = document.querySelectorAll(".like-button");

  likeButtons.forEach(function (button) {
    button.addEventListener("click", async function () {
      const postId = button.dataset.postId;
      const parent = button.closest(".blogpost-actions");
      const countEl = parent ? parent.querySelector(".like-count") : null;

      try {
        const response = await fetch(`/posts/${postId}/like`, { method: "POST" });
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        button.classList.toggle("liked", Boolean(data.liked));
        button.setAttribute("aria-pressed", data.liked ? "1" : "0");
        if (countEl && typeof data.like_count !== "undefined") {
          countEl.textContent = data.like_count;
        }
        const label = button.querySelector(".like-label");
        if (label) {
          label.textContent = data.liked ? "Je vindt dit leuk" : "Vind ik leuk";
        }
      } catch (error) {
        console.error("Like request failed", error);
      }
    });
  });
});
</script>

{% include "includes/footer.html" %}
